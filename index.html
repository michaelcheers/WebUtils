<html>
<head>
<style>
#textBox
{
   width: 1000px;
   height: 500px;
}
</style>
</head>
<body>
<div id=p0>
    <ul>
        <li><a href="javascript:go(0)">Text Editor</a></li>
        <li><a href="javascript:go(1)">Chat</a></li>
    </ul>
</div>
<div id=p1>
<input type="file" id="upload" onchange="uploadFile(0)" /><br />
Line Terminator: <input id="lineTerminator" value="\r\n" /><br />
Code Type: <select id="languageSelect" onchange="editorChange()"></select>
<div id="textBox">some text</div>
<a href="javascript:saveText()">Download</a>
</div>
<div id="p2">
    <textarea id="message"></textarea>
</div>
<script src="Ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="Ace/theme-twilight.js" type="text/javascript" charset="utf-8"></script>
<script src="Ace/ext-modelist.js"></script>
<script>
var currentExt;
var editor;
changePage(0);
function uploadFile(n, fileReader) {
    switch (n)
    {
        case 0:
            var file = upload.files[0];
            var mode = require("ace/ext/modelist").getModeForPath(file.name).mode;
            languageSelect.value = mode.substr('ace/mode/'.length);
            editorChange();
            var fileReader = new FileReader();
            fileReader.readAsText(file);
            fileReader.onload = function () { uploadFile(1, fileReader); };
            break;
        case 1:
            upload.value = null;
            editor.setValue(fileReader.result.replace(/\r/g, ''));
            break;
        }
}
function editorChange() {
        currentExt = require('ace/ext/modelist').modesByName[languageSelect.value].extensions.split('|')[0];
        var script = document.createElement('script');
        script.src = 'Ace/mode-' + languageSelect.value + '.js';
        script.onload = function () {
            var cMode = require("ace/mode/" + languageSelect.value).Mode;
            editor.session.setMode(new cMode());
        };
        document.head.appendChild(script);
    }
function updateChat(conn)
{
    console.log('updating connection...');
    message.disabled = false;
    message.onkeydown = function (e) {
        if (e.keyCode === 13) {
            console.log("Sending message: " + message.value);
            conn.send(message.value);
            message.value = "";
        }
    };
    conn.on('data', function (data) {
        document.body.appendChild(document.createElement('br'));
        document.body.appendChild(new Text(data));
    });
}
function go (pageN)
{
   switch (pageN)
   {
       case 0:
           changePage(1);
           for (var language in require('ace/ext/modelist').modesByName)
           {
               var option = document.createElement('option');
               option.value = language;
               option.innerHTML = language;
               languageSelect.appendChild(option);
           }
           languageSelect.value = "csharp";
           editor = ace.edit("textBox");
           editor.setTheme("ace/theme/twilight");
           editorChange();
           break;
       case 1:
           message.disabled = true;
           var peer = new Peer(prompt("Choose a username..."), { key: 'q9m5c1m8qc1ve7b9' });
           var username = prompt("Other user's username... Empty if other chatter hasn't started yet...")
           if (username !== "") {
               var conn = peer.connect(username);
               conn.on('open', function () { updateChat(conn) });
           }
           else
               peer.on('connection', updateChat);
           changePage(2);
           break;
   }
}
function saveText ()
{
    var download = document.createElement('a');
    download.href = 'data:;base64,' + btoa(editor.getValue().replace(/\n/g, eval('\'' + lineTerminator.value + '\'')));
    download.download = "download." + currentExt;
    download.click();
}
function changePage (n)
{
    for (var index=0;index<3;index++)
    {
        document.getElementById("p" + index).style.display = n === index ? "initial" : "none";
    }
}
</script>
<script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
</body>
</html>
